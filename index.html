<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Rehab Quest</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header class="topbar">
      <div class="brand" aria-label="Rehab QUEST">
        <svg width="28" height="28" viewBox="0 0 64 64" aria-hidden="true" style="vertical-align:middle;margin-right:8px">
          <defs>
            <linearGradient id="g1" x1="0" x2="1">
              <stop offset="0%" stop-color="var(--primary)" />
              <stop offset="100%" stop-color="var(--accent)" />
            </linearGradient>
          </defs>
          <path d="M8 32c8-8 16-8 24 0s16 8 24 0" fill="none" stroke="url(#g1)" stroke-width="4" stroke-linecap="round">
            <animate attributeName="d" dur="2s" repeatCount="indefinite"
              values="M8 32c8-8 16-8 24 0s16 8 24 0; M8 28c8 8 16 8 24 0s16-8 24 0; M8 32c8-8 16-8 24 0s16 8 24 0" />
          </path>
          <circle cx="32" cy="18" r="4" fill="url(#g1)">
            <animate attributeName="cy" values="18;14;18" dur="2s" repeatCount="indefinite" />
          </circle>
        </svg>
        Rehab QUEST
      </div>
      <nav class="userbar">
        <a href="dashboard.html" class="btn btn-ghost">Dashboard</a>
        <a href="report.html" class="btn btn-ghost">Reports</a>
        <button id="theme-toggle" class="btn btn-ghost" title="Switch theme">ðŸŒ™</button>
        <button id="logout-btn" class="btn">Logout</button>
        <div id="user-badge" class="badge" title=""></div>
      </nav>
    </header>

    <main class="container">

      <!-- Hero / Landing -->
      <section id="intro-screen" class="card hero-card">
        <div class="hero-head">
          <h1 class="hero-title">Rehab <span>QUEST</span></h1>
          <p class="hero-tag">AI-guided recovery for strength and mobility.</p>
          <p class="hero-sub muted">Your personalized path to strength, balance, and recovery â€” guided by AI.</p>
          <div class="actions center" style="margin-top:12px;">
            <button id="start-btn" class="btn btn-primary">Start Exercising</button>
          </div>
        </div>
        <div class="hero-anim">
          <lottie-player class="hero-lottie"
            background="transparent" speed="1" loop autoplay
            data-src-light="https://assets10.lottiefiles.com/packages/lf20_jcikwtux.json"
            data-src-dark="https://assets10.lottiefiles.com/packages/lf20_jcikwtux.json"></lottie-player>
        </div>
        <div class="features">
          <div class="feature" data-reveal>
            <div class="feature-icon" aria-hidden="true">
              <lottie-player class="icon-lottie" background="transparent" speed="1" loop autoplay
                data-src-light="https://assets10.lottiefiles.com/packages/lf20_cwqf5i6h.json"
                data-src-dark="https://assets10.lottiefiles.com/packages/lf20_cwqf5i6h.json"></lottie-player>
            </div>
            <div>
              <div class="feature-title">Smart Exercise Tracking</div>
              <div class="feature-text">Real-time motion feedback using AI.</div>
            </div>
          </div>
          <div class="feature" data-reveal>
            <div class="feature-icon" aria-hidden="true">
              <lottie-player class="icon-lottie" background="transparent" speed="1" loop autoplay
                data-src-light="https://assets10.lottiefiles.com/packages/lf20_tno6cg2w.json"
                data-src-dark="https://assets10.lottiefiles.com/packages/lf20_tno6cg2w.json"></lottie-player>
            </div>
            <div>
              <div class="feature-title">Personal Progress Reports</div>
              <div class="feature-text">Track streaks, reps, and performance trends.</div>
            </div>
          </div>
          <div class="feature" data-reveal>
            <div class="feature-icon" aria-hidden="true">
              <lottie-player class="icon-lottie" background="transparent" speed="1" loop autoplay
                data-src-light="https://assets10.lottiefiles.com/packages/lf20_vh9xqidh.json"
                data-src-dark="https://assets10.lottiefiles.com/packages/lf20_vh9xqidh.json"></lottie-player>
            </div>
            <div>
              <div class="feature-title">Clinician Insights</div>
              <div class="feature-text">Securely share reports with healthcare professionals.</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Exercise selection -->
      <section id="selection-screen" class="card hidden">
        <div class="card-header">
          <h2>Select an exercise</h2>
          <p class="muted">Pick one to begin.</p>
        </div>

        <div class="row gap wrap" style="margin-bottom:8px;">
          <div class="field">
            <label for="target-reps">Target reps per set</label>
            <input id="target-reps" class="input" type="number" min="0" step="1" placeholder="e.g. 10" />
          </div>
          <div class="field">
            <label for="target-sets">Target sets</label>
            <input id="target-sets" class="input" type="number" min="0" step="1" placeholder="e.g. 3" />
          </div>
        </div>

        <div class="grid">
          <button class="btn btn-chip" onclick="startExercise('doubleArm')">Double Arm Raises</button>
          <button class="btn btn-chip" onclick="startExercise('leftArm')">Left Arm Raises</button>
          <button class="btn btn-chip" onclick="startExercise('rightArm')">Right Arm Raises</button>
          <button class="btn btn-chip" onclick="startExercise('leftLeg')">Left Leg Raises</button>
          <button class="btn btn-chip" onclick="startExercise('rightLeg')">Right Leg Raises</button>
          <button class="btn btn-chip" onclick="startExercise('tilt')">Body Tilts</button>
          <button class="btn btn-chip" onclick="startExercise('squats')">Squats</button>
        </div>

        <div class="actions">
          <button class="btn" onclick="goBackToIntro()">Back</button>
          <a class="btn btn-ghost" href="dashboard.html">Go to Dashboard</a>
        </div>
      </section>

      <!-- Exercise screen -->
      <section id="exercise-screen" class="card hidden">
        <div class="card-header row-between">
          <div>
            <h2 id="exercise-title">Exercise</h2>
            <p id="rep-info" class="muted">Reps: 0</p>
          </div>
          <div class="actions">
            <button class="btn" onclick="endExercise()">End Session</button>
          </div>
        </div>

        <div class="video-wrap">
          <div class="floating-controls">
            <button class="btn btn-toggle" id="toggle-mirror">Mirror</button>
            <button class="btn btn-toggle" id="toggle-guides">Guides</button>
            <button class="btn btn-toggle" id="toggle-sound">Sound</button>
          </div>
          <!-- Hidden input video -->
          <video id="video" autoplay playsinline width="640" height="480" class="hidden"></video>
          <!-- Canvas output -->
          <canvas id="output" width="640" height="480"></canvas>
        </div>

        <p class="muted small">
          Tip: Make sure your full body is visible for better tracking.
        </p>
      </section>
    </main>

    <footer class="strip">
      <span class="muted small">Powered by MediaPipe Ã— Firebase Ã— Rehab QUEST AI</span>
    </footer>

    <!-- Report Modal -->
    <dialog id="report-modal" class="modal">
      <div class="modal-card">
        <h3>âœ… Session Complete</h3>
        <p id="report-summary" class="muted"></p>
        <div class="row wrap gap">
          <a class="btn btn-primary" href="dashboard.html">View Progress Dashboard</a>
          <a class="btn" href="report.html">Open Report Page</a>
          <button class="btn btn-ghost" id="export-pdf-btn">Export PDF</button>
          <button class="btn" id="close-report-btn">Close</button>
        </div>
      </div>
    </dialog>

    <!-- MediaPipe libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <!-- PDF -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <!-- Lottie Web Component -->
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>

    <!-- App logic -->
    <script src="auth.js"></script>
    <script src="ui.js"></script>
    <script src="app.js"></script>
    <script>
      // Initialize streak bar
      (function(){
        try {
          const sd = JSON.parse(localStorage.getItem('streakData')||'{}');
          const streak = Math.min(30, sd.streak || 0);
          const pct = Math.round((streak/30)*100);
          document.getElementById('streak-bar').style.width = pct+"%";
        } catch {}
      })();

      // Start Exercising flow: if logged in -> open selection; else -> login then return
      (function(){
        const btn = document.getElementById('start-btn');
        btn?.addEventListener('click', function(){
          try {
            const user = window.RQAuth?.getCurrentUser?.();
            if (user && user.name) {
              window.goToSelection?.();
            } else {
              const url = new URL('login.html', location.href);
              url.searchParams.set('next', 'start');
              location.href = url.toString();
            }
          } catch { location.href = 'login.html'; }
        });

        // Auto-start selection if redirected with start flag
        try {
          const params = new URLSearchParams(location.search);
          if (params.get('start') === '1' || params.get('next') === 'start') {
            window.goToSelection?.();
          }
        } catch {}
      })();
    </script>
  </body>
</html>
